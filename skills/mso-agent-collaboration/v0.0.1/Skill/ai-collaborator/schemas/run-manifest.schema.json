{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "run-manifest.schema.json",
  "title": "Run Manifest",
  "description": "전체 실행 단위(run) 메타데이터. 태스크 배열, 설정 해시, 집계 지표를 포함한다.",
  "type": "object",
  "required": [
    "run_id",
    "created_at",
    "status",
    "tasks",
    "config_hash",
    "system_rules_hash"
  ],
  "properties": {
    "run_id": {
      "type": "string",
      "pattern": "^run-[0-9]{8}-[a-z0-9]{6}$"
    },
    "created_at": {
      "type": "string",
      "format": "date-time",
      "description": "실행 생성 시각 (ISO 8601)"
    },
    "completed_at": {
      "type": ["string", "null"],
      "format": "date-time",
      "description": "실행 완료 시각 (미완료 시 null)"
    },
    "status": {
      "type": "string",
      "enum": ["pending", "in_progress", "completed", "failed", "aborted"],
      "description": "전체 실행 상태"
    },
    "tasks": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["task_id", "status"],
        "properties": {
          "task_id": { "type": "string" },
          "owner_agent": { "type": "string" },
          "role": {
            "type": "string",
            "enum": ["planner", "worker", "reviewer", "merge_agent"]
          },
          "status": {
            "type": "string",
            "enum": ["pending", "in_progress", "success", "failure", "blocked", "timeout"]
          },
          "exit_code": { "type": "string" },
          "depends_on": {
            "type": "array",
            "items": { "type": "string" }
          }
        },
        "additionalProperties": false
      },
      "description": "실행 내 태스크 목록 및 상태"
    },
    "config_hash": {
      "type": "string",
      "pattern": "^sha256:[a-f0-9]{64}$",
      "description": "workflow-config.yaml의 SHA-256 해시"
    },
    "system_rules_hash": {
      "type": "string",
      "pattern": "^sha256:[a-f0-9]{64}$",
      "description": "불변 시스템 규칙의 SHA-256 해시"
    },
    "aggregate_metrics": {
      "type": "object",
      "properties": {
        "total_tasks": {
          "type": "integer",
          "minimum": 0
        },
        "succeeded": {
          "type": "integer",
          "minimum": 0
        },
        "failed": {
          "type": "integer",
          "minimum": 0
        },
        "total_duration_seconds": {
          "type": "number",
          "minimum": 0
        },
        "total_tokens": {
          "type": "integer",
          "minimum": 0
        },
        "retry_total": {
          "type": "integer",
          "minimum": 0
        },
        "conflict_count": {
          "type": "integer",
          "minimum": 0
        }
      },
      "additionalProperties": true,
      "description": "실행 전체 집계 지표"
    }
  },
  "additionalProperties": false
}
