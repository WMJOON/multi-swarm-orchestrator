{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "output-report.schema.json",
  "title": "Output Report",
  "description": "Worker/Reviewer 완료 보고 구조. 상태, 변경 파일, 품질 게이트 결과 등을 포함한다.",
  "type": "object",
  "required": [
    "run_id",
    "task_id",
    "status",
    "exit_code",
    "changed_files",
    "summary",
    "next_action"
  ],
  "properties": {
    "run_id": {
      "type": "string",
      "pattern": "^run-[0-9]{8}-[a-z0-9]{6}$"
    },
    "task_id": {
      "type": "string",
      "pattern": "^task-[0-9]{3,}$"
    },
    "status": {
      "type": "string",
      "enum": ["success", "failure", "partial", "blocked", "timeout"],
      "description": "태스크 완료 상태"
    },
    "exit_code": {
      "type": "string",
      "pattern": "^[ESPQMDX]-[0-9]{3}$",
      "description": "표준 에러/성공 코드 (예: E-000 성공, S-001 스키마 오류)"
    },
    "changed_files": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["path", "action"],
        "properties": {
          "path": { "type": "string" },
          "action": {
            "type": "string",
            "enum": ["created", "modified", "deleted", "moved"]
          },
          "lines_changed": {
            "type": "integer",
            "minimum": 0
          }
        },
        "additionalProperties": false
      },
      "description": "변경된 파일 목록"
    },
    "summary": {
      "type": "string",
      "minLength": 10,
      "description": "작업 결과 요약"
    },
    "risks": {
      "type": "array",
      "items": { "type": "string" },
      "description": "식별된 위험 요소 목록"
    },
    "next_action": {
      "type": "string",
      "enum": ["proceed", "retry", "escalate", "abort"],
      "description": "다음 행동 권고"
    },
    "quality_gate_results": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["gate", "passed"],
        "properties": {
          "gate": {
            "type": "string",
            "enum": ["lint", "test", "policy_check", "human_approve"]
          },
          "passed": { "type": "boolean" },
          "detail": { "type": "string" },
          "duration_ms": {
            "type": "integer",
            "minimum": 0
          }
        },
        "additionalProperties": false
      },
      "description": "품질 게이트 통과 결과"
    },
    "metrics": {
      "type": "object",
      "properties": {
        "duration_seconds": {
          "type": "number",
          "minimum": 0
        },
        "token_usage": {
          "type": "integer",
          "minimum": 0
        },
        "retry_count": {
          "type": "integer",
          "minimum": 0
        }
      },
      "additionalProperties": true,
      "description": "실행 지표"
    }
  },
  "additionalProperties": false
}
